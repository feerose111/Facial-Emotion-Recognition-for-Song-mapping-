<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emotion Music Recommendation</title>

  <!-- Stylesheets -->
  {% load static %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Bigelow+Rules&display=swap" rel="stylesheet">
  <link type="text/css" href="{% static 'css/style.css' %}" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <style>
    body {
      background:linear-gradient(to right, #030F12,#03181b);
      color: white;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
    }

    .video-area {
      height: 300px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px dashed white;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 20px;
    }

    .button-group .btn {
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <div class="row mb-4 text-center">
      <h1 class="fw-bold">Emotion Music Recommender</h1>
      <p>FERS: Reflecting Real Feelings</p>
    </div>
    <div class="row">
      <!-- Video Capture Area -->
      <div class="col-md-6">
        <div class="card p-4">
          <h3 class="card-title text-center mb-3">Capture Video</h3>
          <div class="video-area" id="video-area">
            <video id="video" autoplay muted playsinline></video>
          </div>
          <div class="text-center mt-3">
            <button id="startCapture" class="btn btn-primary">
              <i class="fas fa-camera"></i> Start Capture
            </button>
            <button id="stopCapture" class="btn btn-danger" disabled>
              <i class="fas fa-stop-circle"></i> Stop Capture
            </button>
          </div>
          
        </div>
      </div>
      <!-- Song List Mapping -->
      <div class="col-md-6">
        <div class="card p-4">
          <h3 class="card-title text-center mb-3">Mood Playlists</h3>
          <table class="table table-striped table-dark table-hover">
            <thead>
              <tr>
                <th>Song</th>
                <th>Recommended URL</th>
              </tr>
            </thead>
            <tbody id="songList">
              <tr>
                <td>Happy Song</td>
                <td><a href="#" class="text-info">Link 1</a></td>
              </tr>
              <tr>
                <td>Relaxing Tune</td>
                <td><a href="#" class="text-info">Link 2</a></td>
              </tr>
              <tr>
                <td>Upbeat Track</td>
                <td><a href="#" class="text-info">Link 3</a></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Navigation Buttons -->
    <div class="row mt-4">
      <div class="col text-center button-group">
        <a href="{% url 'home' %}" class="btn btn-light">
          <i class="fas fa-home"></i> Home
        </a>
        <button class="btn btn-secondary" onclick="window.location.reload();">
          <i class="fas fa-redo"></i> Refresh
        </button>
          <a href="{% url  'feedback' %}">
            <button id="feedback" class="btn btn-primary">
              Feedbacks
           </button>
          </a>              
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
  crossorigin="anonymous"></script>
  <script>
    const videoElement = document.getElementById('video');
    const startCaptureButton = document.getElementById('startCapture');
    const stopCaptureButton = document.getElementById('stopCapture');

    let mediaStream = null;

    // Start video capture
    startCaptureButton.addEventListener('click', async () => {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoElement.srcObject = mediaStream;
        startCaptureButton.disabled = true;
        stopCaptureButton.disabled = false;
        console.log('Start Button Disabled:', startCaptureButton.disabled);
      } catch (err) {
        alert('Error accessing camera: ' + err.message);
      }
    });
    // Stop video capture
    stopCaptureButton.addEventListener('click', () => {
    if (mediaStream) {
      // Get all tracks from the media stream
      const tracks = mediaStream.getTracks();

      // Stop each track
      tracks.forEach(track => track.stop());

      // Clear the media stream
      mediaStream = null;

      // Remove video stream source
      videoElement.srcObject = null;

      // Update button states
      startCaptureButton.disabled = false;
      stopCaptureButton.disabled = true;
      console.log('Stop Button Enabled:', stopCaptureButton.disabled);
    } else {
      alert('No active video stream to stop.');
    }
    });



    // Periodically update the song list (dummy data example)
    setInterval(() => {
      $.getJSON('/t', function (data) {
        console.log('Data received from /t:', data);
        const songList = $('#songList');
        songList.empty(); // Clear existing songs
        data.forEach((item, index) => {
          songList.append(`<tr>
            <td>Song ${index + 1}</td>
            <td><a href="${item.uri}" target="_blank" class="text-info">${item.uri}</a></td>
          </tr>`);
        });
      });
    }, 10000); // Update every 10 seconds
  </script>
</body>

</html>
